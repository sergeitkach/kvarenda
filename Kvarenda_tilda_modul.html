<script src='https://cdn.jsdelivr.net/gh/sergeitkach/kvarenda@3d6a76a244865bc9e4eea11c9bff9b1f5e5788a8/Kvarenda.js'></script>
<script src='https://cdn.jsdelivr.net/gh/sergeitkach/kvarenda@3d612b396563366437aaf3450c68b286c0214fb8/KvarendaPDF.js'></script>
<script src='https://cdn.jsdelivr.net/npm/pdfmake@0.1.68/build/pdfmake.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/pdfmake@0.1.68/build/vfs_fonts.min.js'></script>
<script type='text/javascript'>

const formId = '244219273';
const popupId = '244218722';

function setKvarendaParams(){

	Kvarenda.ownCreditRate = 0.08;
	Kvarenda.clientAnnuityRate = 0.12;
	Kvarenda.saleDiscount = 0.10;
	Kvarenda.agencyCommission =  0.025;
	Kvarenda.saleTime = 3;
	Kvarenda.requiredIncomeRatio = 1;
	Kvarenda.nonPaymentMonth = 3;

}

function calc(propertyCost, clientMonthlyPayment, paymentsNumber, initialFee, constructionTime, resultHTML=''){

	resultHTML = resultHTML + "<div id='Kvarenda'><div id='error'></div><div id='pdf-block'></div><div id='params'></div><div id='customer-table'></div></div>";

	resultDOM = new DOMParser().parseFromString(resultHTML, "text/html"); 

	let result = Kvarenda.calc(propertyCost, clientMonthlyPayment, paymentsNumber, initialFee, constructionTime);

	if (Kvarenda.error){
		
		let errorText = 'Неизвестная ошибка. Попробуйте ещё раз'

		if(Kvarenda.error == 'EconomicError'){
			errorText = 'Стоимость квартиры, размер ежемесячного платежа и срок - не согласуются между собой. Исправьте значения или введите любые два из них - третье будет рассчитано автоматически.';   
		}else if(Kvarenda.error == 'RequiredParametersError'){
			errorText = 'Стоимость квартиры, размер ежемесячного платежа и срок - необходимо задать хотя бы два из этих трёх параметров.';
		}

		let errorBlock = resultDOM.getElementById('error');
		errorBlock.innerHTML = errorText;

	}else{
		
		let paramsTable = '<table>';
		let paramsData = [];
		paramsData.push(
							[{text:'Стоимость квартиры', style:'tableHeader'}, numberWithSpaces(Math.round(result.propertyCost), " ") + ' руб'],
							[{text:'Ежемесячный платёж', style:'tableHeader'}, numberWithSpaces(Math.round(result.clientMonthlyPayment), " ") + ' руб'],
							[{text:'Количество платежей', style:'tableHeader'}, result.paymentsNumber],
							[{text:'Начальный взнос', style:'tableHeader'}, numberWithSpaces(Math.round(result.guaranteeFee + result.initialFee), " ") + ' руб']
						);

		paramsTable = paramsTable + '<tr><td>Стоимость квартиры</td><td>' + numberWithSpaces(Math.round(result.propertyCost)) + ' руб' + '</td></tr>';
		paramsTable = paramsTable + '<tr><td>Ежемесячный платёж</td><td>' + numberWithSpaces(Math.round(result.clientMonthlyPayment)) + ' руб' + '</td></tr>';
		paramsTable = paramsTable + '<tr><td>Количество платежей</td><td>' + result.paymentsNumber + '</td></tr>';
		paramsTable = paramsTable + '<tr><td>Начальный взнос</td><td>' + numberWithSpaces(Math.round(result.guaranteeFee + result.initialFee)) + ' руб' + '</td></tr>';

		paramsTable = paramsTable + '</table>';

		let paramsBlock = resultDOM.getElementById('params');
		paramsBlock.innerHTML = paramsTable;

		let customerTable ='<table><tr><th>Дата</th><th>Арендный платёж, руб.</th><th>Выкупной платёж со взносами, руб.</th><th>Итого платёж, руб.</th><th>Комиссия за досрочное погашение, руб.</th><th>Сумма выкупных платежей, руб.</th><th>Штраф за расторжение: % от выкупных платежей</th><th>Штраф за расторжение: сумма, руб.</th><th>Возврат, руб.</th></tr>';

		let tableData = [];
		tableData.push([
						{
							text: 'Дата',
							style: 'tableHeader'
						},
						{
							text: 'Арендный платёж, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Выкупной платёж со взносами, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Итого платёж, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Комиссия за досрочное погашение, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Сумма выкупных платежей, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Штраф за расторжение: % от выкупных платежей',
							style: 'tableHeader'
						},
						{
							text: 'Штраф за расторжение: сумма, руб.',
							style: 'tableHeader'
						},
						{
							text: 'Возврат, руб.',
							style: 'tableHeader'
						}
					]);

		result.model.forEach(function(item, i, arr) {

			if(i==0){
				return;
			}

			customerTable = customerTable + '<tr>';

			customerTable = customerTable + '<td>' + ((typeof(item.date) === 'undefined') ? '' : item.date.toLocaleString([], {day: '2-digit', month:'2-digit', year: 'numeric'})) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.pmt_rent) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_rent))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.pmt_buyout) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_buyout))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.pmt_total) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_total))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.earlyFee_yearMax) === 'undefined') ? '' : numberWithSpaces(Math.round(item.earlyFee_yearMax))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.breakdown_buyout) === 'undefined') ? '' : numberWithSpaces(Math.round(item.breakdown_buyout))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.breakdown_fineMaxPercents) === 'undefined') ? '' : Math.round(item.breakdown_fineMaxPercents).toLocaleString('ru-RU', {style: 'percent'})) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.breakdown_fineMaxYear) === 'undefined') ? '' : numberWithSpaces(Math.round(item.breakdown_fineMaxYear))) + '</td>';
			customerTable = customerTable + '<td>' + ((typeof(item.breakdown_buyout) === 'undefined' || typeof(item.breakdown_fineMaxYear) === 'undefined') ? '' : numberWithSpaces((item.breakdown_fineMaxYear === 0) ? 0 : Math.round(item.breakdown_buyout - item.breakdown_fineMaxYear))) + '</td>';

			customerTable = customerTable + '</tr>';

			tableData.push([
				((typeof(item.date) === 'undefined') ? '' : item.date.toLocaleString([], {day: '2-digit', month:'2-digit', year: 'numeric'})),
				((typeof(item.pmt_rent) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_rent), " ")),
				((typeof(item.pmt_buyout) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_buyout), " ")),
				((typeof(item.pmt_total) === 'undefined') ? '' : numberWithSpaces(Math.round(item.pmt_total), " ")),
				((typeof(item.earlyFee_yearMax) === 'undefined') ? '' : numberWithSpaces(Math.round(item.earlyFee_yearMax), " ")),
				((typeof(item.breakdown_buyout) === 'undefined') ? '' : numberWithSpaces(Math.round(item.breakdown_buyout), " ")),
				((typeof(item.breakdown_fineMaxPercents) === 'undefined') ? '' : Math.round(item.breakdown_fineMaxPercents).toLocaleString('ru-RU', {style: 'percent'})),
				((typeof(item.breakdown_fineMaxYear) === 'undefined') ? '' : numberWithSpaces(Math.round(item.breakdown_fineMaxYear), " ")),
				((typeof(item.breakdown_buyout) === 'undefined' || typeof(item.breakdown_fineMaxYear) === 'undefined') ? '' : numberWithSpaces((item.breakdown_fineMaxYear === 0) ? 0 : Math.round(item.breakdown_buyout - item.breakdown_fineMaxYear), " "))
			]);

		});

		customerTable = customerTable + '</table>';

		let customerTableBlock = resultDOM.getElementById('customer-table');
		customerTableBlock.innerHTML = customerTable;

		let pdfBlock = resultDOM.getElementById('pdf-block');
		pdfBlock.innerHTML = "<input type='submit' id='get-pdf' value='скачать в PDF'>";
		
		let pdfBtn = resultDOM.getElementById('get-pdf');
		pdfBtn.onclick = function() {

			let header = 'Kvarenda';
			let subheader = 'Kvarenda customer table';
			let text = 'Customer table';

			getCustomerTablePDF(header, subheader, text, paramsData, tableData);

		}

	}

	let pdfBtn = resultDOM.getElementById('get-pdf');

	let pdfBtnOnClick = pdfBtn ? pdfBtn.onclick : pdfBtn; 

	return {html: resultDOM.documentElement.outerHTML, pdfBtnOnClick: pdfBtnOnClick};    

}

function numberWithSpaces(x, symbol = "&nbsp;") {
	return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, symbol);
}

	window.onload = function(){

		setKvarendaParams();

		let form = document.getElementById('form' + formId); 
		let button = form.querySelector('[type="submit"]');
		let td_recid = popupId;
		let rec = $('#rec'+td_recid);
		let customCodeHTML =  t868__readCustomCode(rec);

		let propertyCostInput = form.querySelector('[name="propertyCost"]');
		let clientMonthlyPaymentInput = form.querySelector('[name="clientMonthlyPayment"]');
		let paymentsNumberInput = form.querySelector('[name="paymentsNumber"]');
		let initialFeeInput = form.querySelector('[name="initialFee"]');
		let constructionTimeInput = form.querySelector('[name="constructionTime"]');

		propertyCostInput.setAttribute('type', 'number');
		clientMonthlyPaymentInput.setAttribute('type', 'number');
		paymentsNumberInput.setAttribute('type', 'number');
		initialFeeInput.setAttribute('type', 'number');
		constructionTimeInput.setAttribute('type', 'number');

		form.classList.remove('js-form-proccess');

		button.onclick = function(event) {

			let propertyCost = propertyCostInput.value;
			let clientMonthlyPayment = clientMonthlyPaymentInput.value;
			let paymentsNumber = paymentsNumberInput.value;
			let initialFee = initialFeeInput.value;
			let constructionTime = constructionTimeInput.value;

			let calcResult = calc(propertyCost != '' ? parseFloat(propertyCost): 0,
					clientMonthlyPayment != '' ? parseFloat(clientMonthlyPayment) : 0,
					paymentsNumber != '' ? parseFloat(paymentsNumber) : 0,
					initialFee != '' ? parseFloat(initialFee) : 0,
					constructionTime != '' ? parseFloat(constructionTime) : 0,
					customCodeHTML);

			let resultCode = calcResult.html; 

			t868_showPopup(td_recid, resultCode);

			let pdfBtn = document.getElementById('get-pdf');
			if(pdfBtn){
				pdfBtn.onclick = calcResult.pdfBtnOnClick;
			}

			event.preventDefault();

		}

	}

</script>
<style>
	#Kvarenda{
	    font-family: 'Roboto',Arial,sans-serif
	}
	#rec244218722 .t-popup__container{
		height: 95%;
		overflow: hidden;
	}
	#Kvarenda{
		height: 100%;
		margin: 20px;
	}
	#params table tr td:nth-child(even),
	#customer-table table td {
		text-align: right;
	}
	#customer-table{
		height: 65%;
		width: fit-content;
		overflow: scrol;
		overflow-x: hidden;
		font-size: 0.8em;
	}
	#form{
		margin-bottom: 50px;
	}
	#pdf-block,
	#params{
		margin-bottom: 20px;
	}
	#customer-table th,
	#customer-table td{
		border: 1px solid black;
	}
	#error{
		color: red;
	}
	.bold{
		font-weight: bold;
	}
</style>